name: GitHub Actions Rain Solver Preview Deployment

on:
  push:
    branches-ignore:
      - main

concurrency:
  group: ${{ github.ref }}-deploy-preview
  cancel-in-progress: true

jobs:
  Deploy-Preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Nix 1/2
        uses: DeterminateSystems/nix-installer-action@v4
      - name: Install Nix 2/2
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Prepare Sushi Lib
        run: ./prep-sushi.sh

      - name: Install Dependencies
        run: nix develop -c npm install

      - name: Build
        run: nix develop -c npm run build

      - name: Create GitHub Deployment
        id: deployment
        uses: bobheadxi/deployments@v1
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: preview
          ref: ${{ github.sha }}

      - name: Deploy Rain Solver
        run: nix develop -c node arb-bot
        env:
          IS_PREVIEW: true
          TRACER_SERVICE_NAME: github-preview-${{ github.sha }}
          RPC_URL: ${{ secrets.PREVIEW_RPC_URL }}
          HYPERDX_API_KEY: ${{ secrets.PREVIEW_HYPERDX_API_KEY }}
          BOT_WALLET_PRIVATEKEY: ${{ secrets.PREVIEW_BOT_WALLET_PRIVATEKEY }}
          MAX_RATIO: ${{ vars.PREVIEW_MAX_RATIO }}
          SUBGRAPH: ${{ vars.PREVIEW_SUBGRAPH }}
          LIQUIDITY_PROVIDERS: ${{ vars.PREVIEW_LIQUIDITY_PROVIDERS }}
          ARB_ADDRESS: ${{ vars.PREVIEW_ARB_ADDRESS }}
          GENERIC_ARB_ADDRESS: ${{ vars.PREVIEW_GENERIC_ARB_ADDRESS }}
          BOT_MIN_BALANCE: ${{ vars.PREVIEW_BOT_MIN_BALANCE }}
          GAS_PRICE_MULTIPLIER: ${{ vars.PREVIEW_GAS_PRICE_MULTIPLIER }}
          RP_ONLY: ${{ vars.PREVIEW_RP_ONLY }}
          TX_GAS: ${{ vars.PREVIEW_TX_GAS }}
          DISPAIR: ${{ vars.PREVIEW_DISPAIR }}

      - name: Update Deployment Status
        uses: bobheadxi/deployments@v1
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          env: preview
          status: success
          ref: ${{ github.sha }}
          override: false
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: https://www.hyperdx.io/search?q=%28%28service%3A%22github-preview-${{ github.sha }}%22%29%29
